<?php

namespace App\Services;

use GuzzleHttp\Client;
use GuzzleHttp\Exception\RequestException;
use Illuminate\Support\Facades\Log;

class GeminiService
{
    private Client $httpClient;
    private string $apiKey;
    private string $baseUrl;

    public function __construct()
    {
        $this->httpClient = new Client([
            'timeout' => 60,
            'connect_timeout' => 10,
        ]);
        
        $this->apiKey = config('services.gemini.api_key');
        $this->baseUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent';
        
        if (!$this->apiKey) {
            throw new \Exception('Gemini API key is not configured. Please set GEMINI_API_KEY in your .env file.');
        }
    }

    /**
     * توليد محتوى باستخدام Gemini API
     */
    public function makeRequest($prompt)
    {
        try {
            // إعداد محسن للطلبات الطويلة
            $response = $this->httpClient->post('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent', [
                'query' => [
                    'key' => $this->apiKey
                ],
                'json' => [
                    'contents' => [
                        [
                            'parts' => [
                                ['text' => $prompt]
                            ]
                        ]
                    ],
                    'generationConfig' => [
                        'temperature' => 0.7,
                        'topK' => 40,
                        'topP' => 0.95,
                        'maxOutputTokens' => 4096, // تقليل الحد الأقصى للتوكينات
                    ]
                ],
                'timeout' => 120, // زيادة timeout إلى دقيقتين
                'connect_timeout' => 30,
                'read_timeout' => 150,
                'http_errors' => false // منع رمي استثناءات HTTP
            ]);

            $statusCode = $response->getStatusCode();
            $body = $response->getBody()->getContents();
            
            // فحص رمز الاستجابة
            if ($statusCode !== 200) {
                \Log::error("Gemini API HTTP Error: {$statusCode} - {$body}");
                throw new \Exception("Gemini API returned status {$statusCode}");
            }
            
            $data = json_decode($body, true);
            
            if (!$data) {
                \Log::error("Invalid JSON response from Gemini: {$body}");
                throw new \Exception('Invalid JSON response from Gemini API');
            }
            
            if (isset($data['error'])) {
                \Log::error('Gemini API Error Response: ' . json_encode($data['error']));
                throw new \Exception('Gemini API Error: ' . ($data['error']['message'] ?? 'Unknown error'));
            }
            
            if (isset($data['candidates'][0]['content']['parts'][0]['text'])) {
                $result = $data['candidates'][0]['content']['parts'][0]['text'];
                \Log::info('Gemini API Success: Generated ' . strlen($result) . ' characters');
                return $result;
            }
            
            \Log::error('Unexpected Gemini response structure: ' . json_encode($data));
            throw new \Exception('Invalid response structure from Gemini API');
            
        } catch (\GuzzleHttp\Exception\ConnectException $e) {
            \Log::error('Gemini Connection Error: ' . $e->getMessage());
            throw new \Exception('فشل في الاتصال بخدمة Gemini: مشكلة في الشبكة');
        } catch (\GuzzleHttp\Exception\RequestException $e) {
            \Log::error('Gemini Request Error: ' . $e->getMessage());
            throw new \Exception('خطأ في طلب Gemini: ' . $e->getMessage());
        } catch (\Exception $e) {
            \Log::error('Gemini General Error: ' . $e->getMessage());
            
            // التحقق من نوع الخطأ وإرجاع رسالة مناسبة
            if (strpos($e->getMessage(), 'timeout') !== false) {
                throw new \Exception('انتهت مهلة الاتصال بخدمة Gemini. يرجى المحاولة مرة أخرى.');
            }
            
            throw new \Exception('خطأ في خدمة الذكاء الاصطناعي: ' . $e->getMessage());
        }
    }

    /**
     * توليد خطة درس باستخدام Gemini
     */
    public function generateLessonPlan(array $data): string
    {
        $prompt = $this->buildLessonPlanPrompt($data);
        
        return $this->makeRequest($prompt);
    }

    /**
     * توليد أهداف تعليمية باستخدام Gemini
     */
    public function generateObjectives(array $data): string
    {
        $prompt = $this->buildObjectivesPrompt($data);
        
        return $this->makeRequest($prompt);
    }

    /**
     * توليد اختبار باستخدام Gemini
     */
    public function generateQuiz(array $data): string
    {
        $prompt = $this->buildQuizPrompt($data);
        
        return $this->makeRequest($prompt);
    }

    /**
     * توليد أنشطة تعليمية باستخدام Gemini
     */
    public function generateActivity(array $data): string
    {
        $prompt = $this->buildActivityPrompt($data);
        
        return $this->makeRequest($prompt);
    }

    /**
     * توليد رسائل أولياء الأمور باستخدام Gemini
     */
    public function generateParentMessage(array $data): string
    {
        $prompt = $this->buildParentMessagePrompt($data);
        
        return $this->makeRequest($prompt);
    }

    /**
     * توليد معايير تقييم باستخدام Gemini
     */
    public function generateRubric(array $data): string
    {
        $prompt = $this->buildRubricPrompt($data);
        
        return $this->makeRequest($prompt);
    }

    /**
     * توليد قصة تعليمية باستخدام Gemini
     */
    public function generateStory(array $data): string
    {
        $prompt = $this->buildStoryPrompt($data);
        
        return $this->makeRequest($prompt);
    }

    /**
     * تبسيط مفهوم باستخدام Gemini
     */
    public function generateConceptSimplification(array $data): string
    {
        $prompt = $this->buildConceptPrompt($data);
        
        return $this->makeRequest($prompt);
    }

    /**
     * توليد استراتيجيات تدريس باستخدام Gemini
     */
    public function generateStrategy(array $data): string
    {
        $prompt = $this->buildStrategyPrompt($data);
        
        return $this->makeRequest($prompt);
    }

    /**
     * توليد ملاحظات تقرير الأداء باستخدام Gemini
     */
    public function generatePerformanceReview(array $data): string
    {
        $prompt = $this->buildPerformanceReviewPrompt($data);
        
        return $this->makeRequest($prompt);
    }

    /**
     * توليد ملاحظات السجل باستخدام Gemini
     */
    public function generateReportCard(array $data): string
    {
        $prompt = $this->buildReportCardPrompt($data);
        
        return $this->makeRequest($prompt);
    }

    // ===== Prompt Builders =====

    private function buildLessonPlanPrompt(array $data): string
    {
        return "أنت معلم متخصص ومساعد تعليمي ذكي. مهمتك إنشاء خطة درس تفصيلية ومهنية باللغة العربية.

المعلومات المقدمة:
- المادة: {$data['subject']}
- الصف: {$data['grade']}
- الموضوع: {$data['topic']}

يرجى إنشاء خطة درس شاملة تتضمن:

## 1. معلومات الدرس الأساسية
- عنوان الدرس
- المدة الزمنية المقترحة
- المرحلة والصف الدراسي

## 2. الأهداف التعليمية
- أهداف معرفية (معلومات ومعارف)
- أهداف مهارية (قدرات عملية)
- أهداف وجدانية (قيم واتجاهات)

## 3. المتطلبات السابقة
- المعارف والمهارات المطلوبة قبل الدرس

## 4. الوسائل والأدوات التعليمية
- الأدوات المطلوبة
- الوسائل التقنية
- المواد والمصادر

## 5. سير الدرس بالتفصيل
### التمهيد (5-10 دقائق)
### العرض والشرح (20-25 دقيقة)
### الأنشطة والتطبيق (10-15 دقائق)
### الخلاصة والتقويم (5 دقائق)

## 6. الأنشطة التفاعلية
- أنشطة فردية
- أنشطة جماعية
- أنشطة عملية

## 7. التقويم والتقييم
- التقويم التكويني (أثناء الدرس)
- التقويم الختامي (نهاية الدرس)
- أساليب التقييم المقترحة

## 8. الواجبات والأنشطة المنزلية
- تطبيقات عملية
- أسئلة للمراجعة

## 9. التمايز في التعليم
- استراتيجيات للطلاب المتفوقين
- دعم إضافي للطلاب الذين يحتاجون مساعدة

## 10. الربط مع الحياة العملية
- تطبيقات الموضوع في الواقع
- أمثلة من البيئة المحلية

يرجى جعل المحتوى:
- مناسب للمرحلة العمرية المحددة
- تفاعلي وممتع
- واضح ومفصل
- قابل للتطبيق العملي
- يراعي الفروق الفردية بين الطلاب";
    }

    private function buildObjectivesPrompt(array $data): string
    {
        return "أنت خبير في المناهج والأهداف التعليمية. مهمتك إنشاء أهداف تعليمية واضحة ومحددة وقابلة للقياس باللغة العربية.

المعلومات المقدمة:
- المادة: {$data['subject']}
- الصف: {$data['grade']}
- الموضوع: {$data['topic']}

يرجى إنشاء مجموعة أهداف تعليمية شاملة مقسمة إلى:

## الأهداف المعرفية (Cognitive Objectives)
يجب أن يكون الطالب قادراً على:
- (اذكر 4-6 أهداف معرفية باستخدام أفعال قابلة للقياس مثل: يذكر، يحدد، يشرح، يحلل، يقارن، يستنتج)

## الأهداف المهارية (Psychomotor Objectives)
يجب أن يكون الطالب قادراً على:
- (اذكر 3-4 أهداف مهارية باستخدام أفعال مثل: يؤدي، ينفذ، يطبق، يستخدم، يرسم، يبني)

## الأهداف الوجدانية (Affective Objectives)
يجب أن يكون الطالب قادراً على:
- (اذكر 2-3 أهداف وجدانية باستخدام أفعال مثل: يقدر، يحترم، يهتم، يشارك، يتعاون)

## الأهداف طويلة المدى
- أهداف عامة للوحدة أو الفصل الدراسي

معايير الأهداف الجيدة:
- محددة (Specific)
- قابلة للقياس (Measurable)
- قابلة للتحقيق (Achievable)
- واقعية (Realistic)
- محددة بزمن (Time-bound)

يرجى التأكد من أن جميع الأهداف:
- مصاغة بوضوح ودقة
- تستخدم أفعال سلوكية قابلة للملاحظة والقياس
- مناسبة للمرحلة العمرية
- تغطي جوانب التعلم المختلفة
- متدرجة في الصعوبة حسب تصنيف بلوم";
    }

    private function buildQuizPrompt(array $data): string
    {
        return "أنت خبير في إعداد الاختبارات التعليمية. مهمتك إنشاء اختبار شامل ومتنوع باللغة العربية.

المعلومات المقدمة:
- المادة: {$data['subject']}
- الصف: {$data['grade']}
- الموضوع: {$data['topic']}
- عدد الأسئلة المطلوب: {$data['questions_count']}
- نوع الاختبار: {$data['quiz_type']}

يرجى إنشاء اختبار يحتوي على:

## معلومات الاختبار
- اسم الاختبار
- المادة والصف
- الزمن المقترح للإجابة
- الدرجة الكلية

## الأسئلة

### القسم الأول: أسئلة الاختيار من متعدد (40% من الدرجات)
(اذكر أسئلة اختيار من متعدد مع 4 خيارات لكل سؤال، مع تحديد الإجابة الصحيحة)

### القسم الثاني: أسئلة الصواب والخطأ (20% من الدرجات)
(اذكر أسئلة صواب وخطأ مع تصحيح العبارات الخاطئة)

### القسم الثالث: أسئلة إكمال الفراغات (20% من الدرجات)
(اذكر أسئلة إكمال الفراغات مع الإجابات)

### القسم الرابع: أسئلة مقالية قصيرة (20% من الدرجات)
(اذكر أسئلة تتطلب إجابات مقالية قصيرة مع نماذج الإجابة)

## نموذج الإجابة
- الإجابات الصحيحة لجميع الأسئلة
- توزيع الدرجات
- معايير التصحيح للأسئلة المقالية

## تعليمات للطلاب
- كيفية الإجابة على كل نوع من الأسئلة
- الزمن المخصص لكل قسم
- نصائح عامة للاختبار

يرجى التأكد من أن الاختبار:
- يغطي جميع جوانب الموضوع المهمة
- متدرج في الصعوبة من السهل إلى الصعب
- يناسب المستوى العمري والأكاديمي للطلاب
- يحتوي على أسئلة تقيس مستويات مختلفة من التفكير
- واضح ومحدد في الصياغة
- خالي من الأخطاء اللغوية والعلمية";
    }

    private function buildActivityPrompt(array $data): string
    {
        return "أنت خبير في الأنشطة التعليمية التفاعلية. مهمتك إنشاء أنشطة تعليمية ممتعة وفعالة باللغة العربية.

المعلومات المقدمة:
- المادة: {$data['subject']}
- الصف: {$data['grade']}
- الموضوع: {$data['topic']}

يرجى اقتراح مجموعة من الأنشطة التعليمية المتنوعة:

## الأنشطة الفردية
### النشاط الأول: [اسم النشاط]
- **الهدف:** (هدف واضح للنشاط)
- **المدة:** (الوقت المطلوب)
- **الأدوات المطلوبة:** (قائمة بالأدوات)
- **خطوات التنفيذ:** (خطوات واضحة ومفصلة)
- **التقييم:** (كيفية تقييم النشاط)

### النشاط الثاني: [اسم النشاط]
(نفس التفاصيل السابقة)

## الأنشطة الجماعية
### النشاط الأول: [اسم النشاط]
- **الهدف:**
- **حجم المجموعة:** (عدد الطلاب في كل مجموعة)
- **الأدوار:** (توزيع الأدوار على أعضاء المجموعة)
- **المدة:**
- **الأدوات المطلوبة:**
- **خطوات التنفيذ:**
- **التقييم:**

### النشاط الثاني: [اسم النشاط]
(نفس التفاصيل السابقة)

## الأنشطة التقنية
### استخدام التكنولوجيا في التعلم
- أنشطة باستخدام الحاسوب أو التابلت
- تطبيقات تعليمية مقترحة
- مواقع تعليمية مفيدة

## الأنشطة العملية (اليدوية)
### أنشطة الصنع والبناء
- مشاريع يدوية مرتبطة بالموضوع
- تجارب عملية آمنة
- أنشطة فنية تعليمية

## أنشطة التقييم التفاعلي
- ألعاب تعليمية
- مسابقات ذهنية
- عروض تقديمية

## الأنشطة المنزلية
- مشاريع يمكن عملها في البيت
- أنشطة مع الأسرة
- بحوث قصيرة

## نصائح للمعلم
- كيفية إدارة الأنشطة بفعالية
- طرق تحفيز الطلاب للمشاركة
- كيفية التعامل مع الطلاب الخجولين
- استراتيجيات حل المشاكل أثناء النشاط

يرجى التأكد من أن جميع الأنشطة:
- ممتعة ومشوقة للطلاب
- تحقق الأهداف التعليمية
- مناسبة للعمر والمستوى الأكاديمي
- آمنة للتنفيذ
- تراعي الإمكانيات المتاحة في المدرسة
- تشجع على التفكير النقدي والإبداعي";
    }

    private function buildParentMessagePrompt(array $data): string
    {
        return "أنت خبير في التواصل التربوي مع أولياء الأمور. مهمتك كتابة رسالة مهنية ومؤثرة باللغة العربية.

المعلومات المقدمة:
- اسم الطالب: {$data['student_name']}
- نوع الرسالة: {$data['message_type']}
- الموضوع: {$data['subject']}
- تفاصيل إضافية: {$data['details']}

يرجى كتابة رسالة تتضمن:

## رأس الرسالة
- التاريخ
- السلام والتحية المناسبة
- اسم ولي الأمر المحترم

## المقدمة
- تحية مهذبة ومناسبة
- تعريف بالمرسل (المعلم/ة) والصف

## محتوى الرسالة الأساسي
- عرض الموضوع بوضوح ولطف
- استخدام أسلوب إيجابي ومشجع
- ذكر التفاصيل المهمة بدقة
- تجنب اللوم أو النقد المباشر

## التوصيات والمقترحات
- نصائح عملية وقابلة للتطبيق
- طرق دعم الطالب في المنزل
- خطة عمل مشتركة بين البيت والمدرسة

## الخاتمة
- تأكيد على أهمية التعاون
- عبارات شكر وتقدير
- دعوة للتواصل المستمر
- السلام الختامي

## معلومات التواصل
- رقم الهاتف (إن أمكن)
- البريد الإلكتروني
- أوقات الاستقبال

تعليمات مهمة:
- استخدم لغة مهذبة ومحترمة
- كن واضحاً ومحدداً
- ركز على الحلول وليس المشاكل
- اجعل الرسالة إيجابية ومحفزة
- تأكد من الدقة في المعلومات
- راع الثقافة والبيئة المحلية
- اجعل الرسالة قصيرة ومفيدة (لا تتجاوز 300 كلمة)";
    }

    private function buildRubricPrompt(array $data): string
    {
        return "أنت خبير في التقييم التربوي ووضع معايير التقييم. مهمتك إنشاء rubric (معيار تقييم) مفصل وواضح باللغة العربية.

المعلومات المقدمة:
- المادة: {$data['subject']}
- نوع المهمة: {$data['task_type']}
- الصف: {$data['grade']}
- عدد المستويات: {$data['levels']} (ممتاز، جيد جداً، جيد، مقبول)

يرجى إنشاء معيار تقييم يحتوي على:

## معلومات المعيار
- اسم المهمة أو المشروع
- المادة والصف
- إجمالي النقاط/الدرجات

## معايير التقييم الأساسية

### المعيار الأول: المحتوى والمعرفة العلمية (25 نقطة)
| المستوى | الوصف | النقاط |
|---------|--------|--------|
| ممتاز (23-25) | (وصف دقيق للأداء المتميز) |
| جيد جداً (20-22) | (وصف للأداء الجيد) |
| جيد (17-19) | (وصف للأداء المتوسط) |
| مقبول (15-16) | (وصف للأداء الأدنى المقبول) |
| ضعيف (أقل من 15) | (وصف للأداء غير المقبول) |

### المعيار الثاني: التنظيم والوضوح (20 نقطة)
| المستوى | الوصف | النقاط |
|---------|--------|--------|
| ممتاز (18-20) | (وصف دقيق) |
| جيد جداً (16-17) | (وصف للأداء الجيد) |
| جيد (14-15) | (وصف للأداء المتوسط) |
| مقبول (12-13) | (وصف للحد الأدنى) |
| ضعيف (أقل من 12) | (وصف للأداء الضعيف) |

### المعيار الثالث: الإبداع والأصالة (20 نقطة)
(نفس التفاصيل السابقة)

### المعيار الرابع: اللغة والأسلوب (15 نقطة)
(نفس التفاصيل السابقة)

### المعيار الخامس: التقديم والعرض (20 نقطة)
(نفس التفاصيل السابقة)

## إجمالي النقاط: 100 نقطة

## مقياس التقديرات النهائية
- ممتاز: 90-100 نقطة (A)
- جيد جداً: 80-89 نقطة (B)
- جيد: 70-79 نقطة (C)
- مقبول: 60-69 نقطة (D)
- راسب: أقل من 60 نقطة (F)

## تعليمات للمعلم
- كيفية استخدام المعيار بفعالية
- نصائح لتقييم عادل ومتسق
- طريقة إعطاء التغذية الراجعة

## تعليمات للطلاب
- شرح مبسط لمعايير التقييم
- نصائح لتحقيق أفضل النتائج
- أمثلة على الأداء المتميز

يرجى التأكد من أن المعيار:
- واضح ومحدد في كل مستوى
- قابل للقياس والتطبيق
- عادل ومناسب للمرحلة العمرية
- يغطي جميع جوانب المهمة المهمة
- يساعد على التحسين المستمر";
    }

    private function buildStoryPrompt(array $data): string
    {
        return "أنت مؤلف قصص تعليمية للأطفال. مهمتك إنشاء قصة تعليمية ممتعة ومفيدة باللغة العربية.

المعلومات المقدمة:
- المادة: {$data['subject']}
- الموضوع التعليمي: {$data['topic']}
- الفئة العمرية: {$data['age_group']}
- طول القصة: {$data['story_length']}

يرجى كتابة قصة تحتوي على:

## معلومات القصة
- عنوان جذاب ومناسب
- الشخصيات الرئيسية
- المكان والزمان

## القصة الكاملة

### البداية
(اكتب بداية مشوقة تجذب انتباه الأطفال وتقدم الشخصيات والمشكلة)

### الوسط
(اكتب تطوير الأحداث مع دمج المعلومات التعليمية بشكل طبيعي وممتع)

### النهاية
(اكتب خاتمة مُرضية تحل المشكلة وتُرسخ الدرس المتعلم)

## الأهداف التعليمية المحققة
- ما سيتعلمه الأطفال من القصة
- القيم والمبادئ المنقولة
- المهارات المكتسبة

## أنشطة مقترحة بعد القصة
- أسئلة للنقاش
- أنشطة فنية أو يدوية
- ألعاب تعليمية مرتبطة بالقصة

## رسائل تربوية
- القيم الأخلاقية في القصة
- الدروس الحياتية المستفادة
- تطبيقات عملية في حياة الطفل

معايير القصة الجيدة:
- لغة مناسبة للعمر وسهلة الفهم
- أحداث مثيرة ومشوقة
- شخصيات محببة ومقنعة
- حوار طبيعي وواقعي
- معلومات دقيقة وصحيحة علمياً
- رسالة إيجابية وبناءة
- طول مناسب (لا يُمل الأطفال)
- خيال إبداعي مع واقعية مقبولة

يرجى التأكد من أن القصة:
- تحقق التوازن بين التعليم والمتعة
- تستخدم أسلوب السرد الشيق
- تتضمن عناصر التشويق والإثارة المناسبة
- تراعي القيم الثقافية والاجتماعية
- تشجع على القراءة والتعلم
- مناسبة للقراءة الجماعية أو الفردية";
    }

    private function buildConceptPrompt(array $data): string
    {
        return "أنت خبير في التعليم وتبسيط المفاهيم المعقدة. مهمتك تبسيط مفهوم أو موضوع معقد باللغة العربية.

المعلومات المقدمة:
- المفهوم المراد تبسيطه: {$data['concept']}
- الفئة المستهدفة: {$data['target_audience']}
- مستوى التعقيد المطلوب: {$data['complexity_level']}

يرجى تبسيط المفهوم من خلال:

## تعريف المفهوم
- تعريف بسيط وواضح
- الفكرة الأساسية بكلمات مفهومة
- لماذا هذا المفهوم مهم؟

## التشبيهات والأمثلة
### مثال من الحياة اليومية
(اربط المفهوم بشيء مألوف في حياة المتعلم)

### تشبيه مبسط
(استخدم تشبيه يجعل المفهوم أسهل للفهم)

### قصة قصيرة توضيحية
(اكتب قصة بسيطة تشرح المفهوم)

## تفكيك المفهوم إلى أجزاء
### الجزء الأول: [اسم الجزء]
- شرح مبسط
- مثال توضيحي

### الجزء الثاني: [اسم الجزء]
- شرح مبسط
- مثال توضيحي

### الجزء الثالث: [اسم الجزء]
(إذا كان ضرورياً)

## الأخطاء الشائعة
- ما يُفهم خطأً حول هذا المفهوم
- التصحيح بطريقة واضحة

## التطبيقات العملية
- كيف نستخدم هذا المفهوم في الحياة؟
- أمثلة من البيئة المحيطة
- تجارب بسيطة يمكن عملها

## أنشطة للتأكد من الفهم
- أسئلة بسيطة للمراجعة
- تمارين عملية
- ألعاب تعليمية

## الخلاصة
- الفكرة الرئيسية في جملة واحدة
- النقاط الأساسية الثلاث الأهم
- لماذا يجب أن نتذكر هذا المفهوم؟

## نصائح للتذكر
- طرق سهلة لحفظ المفهوم
- كلمات مفتاحية
- علامات أو رموز مساعدة

إرشادات التبسيط:
- استخدم كلمات بسيطة ومألوفة
- تجنب المصطلحات التقنية المعقدة
- اربط المفهوم بخبرات المتعلم السابقة
- استخدم الأمثلة الملموسة والمحسوسة
- كرر النقاط المهمة بطرق مختلفة
- استخدم التدرج من البسيط إلى المعقد
- اجعل التفسير تفاعلياً وممتعاً";
    }

    private function buildStrategyPrompt(array $data): string
    {
        return "أنت خبير في استراتيجيات التدريس والتعلم النشط. مهمتك اقتراح استراتيجيات تدريس فعالة ومبتكرة باللغة العربية.

المعلومات المقدمة:
- المادة: {$data['subject']}
- الموضوع: {$data['topic']}
- الصف: {$data['grade']}
- التحدي التعليمي: {$data['challenge']}

يرجى اقتراح استراتيجيات تدريس متنوعة:

## الاستراتيجية الأولى: [اسم الاستراتيجية]
### الوصف
- شرح مبسط للاستراتيجية
- متى تُستخدم هذه الاستراتيجية؟

### خطوات التطبيق
1. **التحضير:** (ما يجب تحضيره مسبقاً)
2. **البداية:** (كيفية بدء الحصة)
3. **التنفيذ:** (خطوات التطبيق التفصيلية)
4. **الخاتمة:** (كيفية إنهاء النشاط)

### المميزات
- لماذا هذه الاستراتيجية فعالة؟
- ما الفوائد للطلاب؟

### الأدوات المطلوبة
- قائمة بالمواد والأدوات
- التقنيات المساعدة

## الاستراتيجية الثانية: [اسم الاستراتيجية]
(نفس التفاصيل السابقة)

## الاستراتيجية الثالثة: [اسم الاستراتيجية]
(نفس التفاصيل السابقة)

## استراتيجيات لأنماط التعلم المختلفة

### للمتعلمين البصريين
- استراتيجيات تعتمد على الرؤية والألوان
- استخدام الرسوم البيانية والخرائط الذهنية

### للمتعلمين السمعيين
- استراتيجيات تعتمد على الصوت والحوار
- المناقشات والعصف الذهني الصوتي

### للمتعلمين الحركيين
- استراتيجيات تتضمن الحركة والتفاعل
- الأنشطة العملية والتجارب

## استراتيجيات إدارة الصف
### للطلاب النشطين جداً
- طرق توجيه طاقتهم بإيجابية
- أنشطة تفريغ الطاقة الزائدة

### للطلاب الخجولين
- طرق تشجيعهم على المشاركة
- بناء الثقة بالنفس

### للطلاب المتأخرين دراسياً
- استراتيجيات الدعم والمساندة
- التعلم التعاوني والأقران

## التقنيات المساعدة
- التطبيقات التعليمية المفيدة
- المواقع والمصادر الإلكترونية
- أدوات الذكاء الاصطناعي التعليمية

## تقييم فعالية الاستراتيجية
- كيفية قياس نجاح الاستراتيجية
- مؤشرات التحسن في أداء الطلاب
- تعديلات مقترحة حسب النتائج

## نصائح للتطبيق الناجح
- أخطاء شائعة يجب تجنبها
- كيفية التكيف مع الظروف غير المتوقعة
- بناء علاقة إيجابية مع الطلاب

يرجى التأكد من أن جميع الاستراتيجيات:
- مناسبة للمرحلة العمرية
- قابلة للتطبيق في الإمكانيات المتاحة
- تراعي الفروق الفردية
- تحقق الأهداف التعليمية
- ممتعة ومحفزة للطلاب
- تشجع على التفكير النقدي والإبداعي";
    }

    private function buildPerformanceReviewPrompt(array $data): string
    {
        $student_name = $data['student_name'] ?? 'الطالب';
        $subject = $data['subject'] ?? 'المادة';
        $grade = $data['grade'] ?? 'الصف';
        $strengths = $data['strengths'] ?? 'غير محدد';
        $weaknesses = $data['weaknesses'] ?? 'غير محدد';
        $recommendations = $data['recommendations'] ?? 'غير محدد';

        return "اكتب تقرير أداء شامل للطالب {$student_name} في مادة {$subject} - {$grade}.

نقاط القوة: {$strengths}
نقاط الضعف: {$weaknesses}
التوصيات: {$recommendations}

اكتب تقرير مهني يحتوي على:
1. تقييم الأداء العام
2. تحليل نقاط القوة وكيفية تعزيزها
3. خطة لتحسين نقاط الضعف
4. توصيات عملية للطالب وولي الأمر
5. أهداف قابلة للتحقيق للفترة القادمة

استخدم لغة مهنية ومشجعة ومحفزة (250-300 كلمة).

";
    }

    private function buildReportCardPrompt(array $data): string
    {
        return "أنت معلم خبير في كتابة ملاحظات السجلات المدرسية. مهمتك كتابة ملاحظات مهنية ومفيدة باللغة العربية.

المعلومات المقدمة:
- اسم الطالب: {$data['student_name']}
- الصف: {$data['grade']}
- الفصل الدراسي: {$data['semester']}
- درجات المواد: " . json_encode($data['subjects_grades'], JSON_UNESCAPED_UNICODE) . "

يرجى كتابة ملاحظات سجل تحتوي على:

## الأداء الأكاديمي
- تقييم مستوى التحصيل
- مدى إتقان المهارات الأساسية
- التطور مقارنة بالفترات السابقة

## المشاركة والتفاعل
- مستوى المشاركة في الحصص
- جودة الأسئلة والتعليقات
- التفاعل مع الأنشطة الصفية

## أداء الواجبات والتكليفات
- انتظام تسليم الواجبات
- جودة الأعمال المنجزة
- الالتزام بالمواعيد المحددة

## السلوك والانضباط
- احترام قوانين الصف
- التعامل مع الزملاء والمعلمين
- مستوى الانضباط العام

## نقاط القوة الملاحظة
(اذكر 2-3 نقاط قوة محددة مع أمثلة)

## مجالات التحسين
(اذكر 1-2 مجال يحتاج لتطوير مع اقتراحات)

## التوصيات
### للطالب
- نصائح للتحسين
- مهارات يجب التركيز عليها

### لولي الأمر
- كيفية الدعم في المنزل
- متابعة نقاط معينة

## رسالة تشجيعية
- كلمات تحفيزية مناسبة
- التأكيد على الإمكانيات
- تشجيع للمواصلة والتطور

معايير الملاحظات الجيدة:
- واضحة ومحددة
- موضوعية وعادلة
- بناءة ومفيدة
- مناسبة للعمر
- تركز على التطوير
- لغة مهذبة ومحترمة
- طول مناسب (150-200 كلمة)

أسلوب الكتابة:
- استخدم ضمير الغائب للطالب
- تجنب العبارات السلبية المحبطة
- ركز على السلوكيات وليس الشخصية
- اقترح حلول عملية للتحسين
- اربط الملاحظات بأهداف واضحة";
    }
}